<!DOCTYPE html>
<html>
<head>
    <title>WebChat - 聊天室</title>
    <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-3">
    <div class="row">
        <!-- 房间列表 -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">房间列表</h5>
                    <div id="room-list"></div>
                    <div class="mt-3">
                        <input type="text" id="new-room-name" class="form-control" placeholder="新房间名称">
                        <button onclick="createRoom()" class="btn btn-sm btn-primary mt-2 w-100">创建房间</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 聊天区域 -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h5 id="current-room-name">请选择房间</h5>
                </div>
                <div id="chat-messages" class="card-body" style="height: 400px; overflow-y: auto;"></div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="输入消息...">
                        <button onclick="sendMessage()" class="btn btn-primary">发送</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let currentRoomId = null;
        let username = null;

        // 初始化：获取当前用户和房间列表
        $(() => {
            // 获取当前登录用户
            $.get('/auth/current-user', (res) => {
                username = res;
                if (!username) window.location.href = '/'; // 未登录跳转登录页
            });

            // 加载房间列表
            loadRooms();
        });

        // 加载房间列表
        function loadRooms() {
            $.get('/rooms', (rooms) => {
                const roomList = $('#room-list');
                roomList.empty();
                rooms.forEach(room => {
                    roomList.append(`
                        <div class="p-2 border rounded mb-2" onclick="joinRoom(${room.id}, '${room.name}')">
                            ${room.name}
                        </div>
                    `);
                });
            });
        }

        // 创建房间
        function createRoom() {
            const roomName = $('#new-room-name').val();
            if (!roomName) return;
            $.post('/rooms', {name: roomName}, () => {
                loadRooms();
                $('#new-room-name').val('');
            });
        }

        // 加入房间
        function joinRoom(roomId, roomName) {
            currentRoomId = roomId;
            $('#current-room-name').text(roomName);
            $('#chat-messages').empty();

            // 连接WebSocket并订阅房间主题
            if (stompClient) stompClient.disconnect();
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, (frame) => {
                // 订阅房间消息
                stompClient.subscribe(`/topic/room/${roomId}`, (msg) => {
                    const message = JSON.parse(msg.body);
                    showMessage(message);
                });
                // 通知加入房间
                stompClient.send(`/app/chat/${roomId}/addUser`, {}, JSON.stringify({
                    user: {username: username}
                }));
            });
        }

        // 显示消息
        function showMessage(message) {
            const isSelf = message.user.username === username;
            $('#chat-messages').append(`
                <div class="mb-2 ${isSelf ? 'text-end' : ''}">
                    <strong>${message.user.username}</strong>: ${message.content}
                </div>
            `);
            // 滚动到底部
            $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
        }

        // 发送消息
        function sendMessage() {
            if (!currentRoomId || !stompClient) return;
            const content = $('#message-input').val();
            if (!content) return;
            stompClient.send(`/app/chat/${currentRoomId}/sendMessage`, {}, JSON.stringify({
                content: content,
                user: {username: username}
            }));
            $('#message-input').val('');
        }

        // 回车发送消息
        $('#message-input').keypress(e => {
            if (e.which === 13) sendMessage();
        });
    </script>
</body>
</html>